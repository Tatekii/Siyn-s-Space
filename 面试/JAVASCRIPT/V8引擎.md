# æ¦‚è¿°
V8 æ˜¯ Google çš„å¼€æºé«˜æ€§èƒ½ JavaScript å’Œ WebAssembly å¼•æ“ï¼Œç”¨ C++ ç¼–å†™ã€‚å®ƒç”¨äº Chrome å’Œ Node.js ç­‰ã€‚
V8 ç¼–è¯‘å¹¶æ‰§è¡Œ JavaScript æºä»£ç ï¼Œå¤„ç†å¯¹è±¡çš„å†…å­˜åˆ†é…ï¼Œå¹¶åƒåœ¾å›æ”¶ä¸å†éœ€è¦çš„å¯¹è±¡ã€‚V8 çš„ Stop-the-worldã€åˆ†ä»£ã€å‡†ç¡®çš„åƒåœ¾å›æ”¶å™¨æ˜¯ V8 æ€§èƒ½çš„å…³é”®ä¹‹ä¸€ã€‚
[https://v8.dev/docs](https://v8.dev/docs)

## å…¶ä»–javascriptå¼•æ“
>chakra => IE9 => Edge
>javascriptCore => Webkit => Safari

# V8æ‰§è¡Œæµç¨‹
1. **Lexical Analysis**
	Converts source code into **tokens**
2. **Parsing**
	Converts tokens into **AST (Abstract Syntax Tree)**
3. **Bytecode Generation**
	AST is compiled into **bytecode** (by â­ï¸`Ignition` in V8)
4. **JIT Compilation & Optimization**
	Frequently used code is compiled into **optimized machine code** (by â­ï¸`TurboFan` in V8)	
		> machineCode can ğŸ’¦deoptimization to byteCode
5. **Execution**
	- Machine Code Runs on CPU
	- Garbage collection and memory handling
## æ³¨æ„ï¼š
1. å­—èŠ‚ç å¯ç›´æ¥è§£é‡Šæ‰§è¡Œï¼Œä½†æ‰§è¡Œæ•ˆç‡è¾ƒæœºå™¨ç æ…¢
2. æœºå™¨ç æ˜¯ç¡¬ä»¶å¯ç›´æ¥æ‰§è¡Œçš„ä½çº§ä»£ç 
3. ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸Šè¿°é˜¶æ®µ4çš„ä¼˜åŒ–ä¸å†æœ‰æ•ˆæˆ–è€…æœ‰æ›´ä¼˜è·¯å¾„ï¼Œä¼šæ‰§è¡Œé€†ä¼˜åŒ–ï¼Œè¿˜åŸå‡ºå­—èŠ‚ç 

# V8çš„ä¸»è¦æ¨¡å—
## âš™ï¸Parser **- Code Parser**
- Converts JavaScript **source code â†’ AST (Abstract Syntax Tree)**.
- Itâ€™s the **first step** before execution.
1. **Pre-Parser** - Quick scan for **syntax errors**.
2. **Full Parser** - Converts code into **AST** for execution.
```json
// let x = 10; AST
{
  "type": "VariableDeclaration",
  "id": { "type": "Identifier", "name": "x" },
  "init": { "type": "Literal", "value": 10 }
}
```
## ğŸ”¥IgnitionÂ **- The Interpreter (Bytecode Engine)**
- **converts JavaScript into bytecode**.
- JavaScript source code â†’ **Lexing & Parsing** â†’ AST â†’ **Bytecode** (via Ignition)
- The bytecode is executed **immediately** and later optimized by the JIT compiler.
```assembly
0x12345678 @ 0 : LdaSmi 5
0x12345679 @ 2 : Star r0
0x12345680 @ 4 : Return
```
## ğŸŒ¬ï¸TurboFanÂ **- The Optimizing JIT Compiler**

- TurboFan is V8â€™s **Just-In-Time (JIT) compiler** that **optimizes** frequently executed code into **machine code**.
- If a function runs **frequently**, TurboFan **recompiles it into efficient machine code**.
- **If assumptions break** (e.g., type changes), it **de-optimizes back** to bytecode.
```javascript
function add(a, b) {
  return a + b;
}

add(2, 3); // Runs in Ignition first
add(4, 5); // Marked as "hot"
```
## ğŸ—ï¸Liftoff **- The WebAssembly Compiler**

## ğŸ§©Orinoco **- The Garbage Collector (ğŸ”¥GCğŸ”¥)**
- **Scavenger (Young Generation GC)** â†’ Quickly cleans **short-lived objects**.
- **Mark-Sweep (Old Generation GC)** â†’ Handles **long-lived objects**.
- **Incremental & Concurrent GC** â†’ Runs in **background** to avoid **blocking** execution.

## ğŸ’³Code Caching **- Optimizing Startup Time**
- Stores **compiled code** to **avoid recompilation** when JavaScript runs again.
- Used in **Chromeâ€™s V8 Cache** and **Service Workers**.

# å†…å­˜ç®¡ç†
javascriptçš„å†…å­˜ç®¡ç†è‡ªåŠ¨çš„ã€‚
```javascript
let obj1 = {}; // ç”³è¯·ç©ºé—´

obj1.name = "mmm"; // ä½¿ç”¨ç©ºé—´

obj1 = null; // é‡Šæ”¾
```

# åƒåœ¾å›æ”¶
## å¸¸è§GCç®—æ³•
### å¼•ç”¨è®¡æ•°
å¼•ç”¨è®¡æ•°å™¨åˆ¤æ–­å¼•ç”¨è®¡æ•°ã€‚
- å‘ç°åƒåœ¾æ—¶ç«‹å³å›æ”¶ï¼ˆå¯¹è±¡ä¸Šä¿å­˜äº†è®¡æ•°å™¨ï¼‰
- æœ€å¤§é™åº¦å‡å°‘ç¨‹åºæš‚åœ
- æ— æ³•å›æ”¶å¾ªç¯å¼•ç”¨
- èµ„æºå¼€é”€è¾ƒå¤§ï¼ˆè®¡æ•°è®°å½•ï¼‰
```javascript
function test() {
	const o1 = {};
	const o2 = {};
	// ä»æ ¹æ— æ³•è®¿é—®åˆ°o1,o2
	// ä½†æ˜¯o1,o2çš„å¼•ç”¨è®¡æ•°éƒ½ä¸æ˜¯0
	// æ— æ³•è¢«å›æ”¶
	o1.a = o2;
	o2.a = o1;
	return 123;
}
test();
```
### æ ‡è®°æ¸…é™¤
*ä¸¤æ¬¡éå†*æ‰€æœ‰å¯¹è±¡ï¼Œæ ‡è®°[[#å¯è¾¾å¯¹è±¡]]ï¼Œæ¸…é™¤æ²¡æœ‰æ ‡è®°çš„å¯¹è±¡ã€‚
- ç©ºé—´ç¢ç‰‡åŒ–ï¼šå›æ”¶çš„ç©ºé—´å¯èƒ½å¾ˆç¢ï¼ˆ å†…å­˜åœ°å€ä¸è¿ç»­ï¼‰ä¸èƒ½æ»¡è¶³æ–°å˜é‡å¼€é—­å†…å­˜ç©ºé—´çš„éœ€æ±‚
- å¯ä»¥å›æ”¶å¾ªç¯å¼•ç”¨
- ä¸èƒ½ç«‹å³å›æ”¶
### æ ‡è®°æ•´ç†
ç›¸è¾ƒäº[[#åƒåœ¾å›æ”¶#æ ‡è®°æ¸…é™¤|æ ‡è®°æ¸…é™¤]]ï¼Œä¼šå¯¹å¯¹è±¡å†…å­˜åœ°å€è¿›è¡Œæ•´ç†ç§»åŠ¨ï¼Œæé«˜ä½¿ç”¨æ•ˆç‡ã€‚

## V8ä¸­çš„åƒåœ¾å›æ”¶
### å¯è¾¾å¯¹è±¡
ä»æ ¹ï¼ˆå…¨å±€ï¼‰å‡ºå‘ï¼Œå¯è®¿é—®åˆ°çš„å¯¹è±¡ã€‚

éå¯è¾¾å¯¹è±¡å°±è¢«è§†ä¸ºå†…å­˜åƒåœ¾ã€‚

### åˆ†ä»£å›æ”¶
v8ä½¿ç”¨åˆ†ä»£å›æ”¶ï¼Œå°†å†…å­˜åˆ†åŒºä¸ºæ–°å£°ä»£å’Œè€ç”Ÿä»£ã€‚
<table >
<thead>
<td colspan=2>æ–°ç”Ÿä»£</td>
<td colspan=2>è€ç”Ÿä»£</td>
</thead>
<tbody>
<tr>
<td colspan=2>64ä½:32M / 32ä½:16M</td>
<td>64ä½:1.4G / 32ä½:700M</td>
</tr>
<tr>
<td>From</td>
<td>To</td>
<td>è€ç”Ÿä»£æŒ‡é’ˆå­˜å‚¨åŒº</td>
<td>è€ç”Ÿä»£æ•°æ®å­˜å‚¨åŒº</td>
</tr>
</tbody>
</table>

### æ–°ç”Ÿä»£ç©ºé—´
å­˜æ´»æ—¶é—´è¾ƒçŸ­çš„å¯¹è±¡
- å¹³åˆ†ä¸¤ä¸ªç­‰å¤§ç©ºé—´
- ä½¿ç”¨ç©ºé—´ä¸º`From`ï¼Œç©ºé—²ç©ºé—´ä¸º`To`
- æ´»åŠ¨å¯¹è±¡å­˜å‚¨åœ¨`From`
- `æ ‡è®°æ•´ç†`åå°†æ´»åŠ¨å¯¹è±¡æ‹·è´åˆ°`To`
- `From`å®Œå…¨é‡Šæ”¾ä¸`To`äº¤æ¢
#### æ™‹å‡
å°†æ–°ç”Ÿä»£å¯¹è±¡ç§»åŠ¨åˆ°è€ç”Ÿä»£
ä¸¤ç§æƒ…å†µè§¦å‘å¯¹è±¡æ™‹å‡ï¼š
1. ä¸€è½® GC åè¿˜å­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ™‹å‡
2. `To`ç©ºé—´ä½¿ç”¨ç‡è¶…è¿‡ 25%
### è€ç”Ÿä»£ç©ºé—´
å­˜æ´»æ—¶é—´è¾ƒé•¿çš„å¯¹è±¡ï¼ˆå…¨å±€å˜é‡ï¼Œé—­åŒ…å†…çš„å˜é‡ï¼‰
- ä¸»è¦ä½¿ç”¨`æ ‡è®°æ¸…é™¤`
- `æ™‹å‡`å‘ç”Ÿæ—¶ï¼Œå¦‚æœå‡ºç°ç©ºé—´ä¸è¶³åˆ™ä¼š`æ ‡è®°æ•´ç†`
- `å¢é‡æ ‡è®°`æé«˜æ•ˆç‡(å°†åƒåœ¾å›æ”¶åˆ†æ­¥æ‰§è¡Œï¼Œä¸ç¨‹åºæ‰§è¡Œäº¤æ›¿è¿›è¡Œï¼Œå‡å°‘ç¨‹åºå•æ¬¡ç­‰å¾…æ—¶é—´)


# JSå¼•æ“

|**å¼•æ“**|**å¼€å‘è€…**|**ä½¿ç”¨ç¯å¢ƒ**|**ç‰¹ç‚¹**|
|---|---|---|---|
|**V8**|Google|Chromeã€Node.js|é«˜æ€§èƒ½ã€JIT ç¼–è¯‘ã€å¹¿æ³›ä½¿ç”¨|
|**SpiderMonkey**|Mozilla|Firefox|å¼€æºã€ä¼˜åŒ–æ”¯æŒ ES6+|
|**JavaScriptCore**|Apple|Safari|ä¸“ä¸º Safari å’Œ WebKit ä¼˜åŒ–|
|**Chakra**|Microsoft|æ—§ç‰ˆ Edgeï¼ˆå·²æ·˜æ±°ï¼‰|å¤šçº¿ç¨‹ä¼˜åŒ–ã€JIT ç¼–è¯‘|
|**Hermes**|Facebook|React Native|é’ˆå¯¹ React Native ä¼˜åŒ–ã€AOT ç¼–è¯‘|
|**Nitro**|Apple|Safari|é«˜æ€§èƒ½ JIT ç¼–è¯‘ã€ä¸“ä¸º Apple è®¾å¤‡ä¼˜åŒ–|
|**QuickJS**|Fabrice Bellard|åµŒå…¥å¼ç³»ç»Ÿã€è½»é‡çº§åº”ç”¨|å°å·§ã€æ”¯æŒæœ€æ–° ECMAScript ç‰¹æ€§|
|**Duktape**|Duktape ç¤¾åŒº|åµŒå…¥å¼ç³»ç»Ÿã€èµ„æºå—é™ç¯å¢ƒ|è½»é‡çº§ã€C è¯­è¨€ç¼–å†™|