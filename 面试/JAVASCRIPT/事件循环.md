
## é¡µé¢è¿›ç¨‹
æµè§ˆå™¨æ¯ä¸€ä¸ªæ ‡ç­¾é¡µä¸€ä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹ä¸­é™¤äº†æ‰§è¡Œjsçš„çº¿ç¨‹è¿˜æœ‰è´Ÿè´£æ¸²æŸ“ï¼Œç½‘ç»œè¯·æ±‚ç­‰çº¿ç¨‹ã€‚

## JS çš„å•çº¿ç¨‹
JavaScript çš„å•çº¿ç¨‹ï¼Œä¸Žå®ƒçš„ç”¨é€”æœ‰å…³ã€‚ä½œä¸ºæµè§ˆå™¨è„šæœ¬è¯­è¨€ï¼ŒJavaScript çš„ä¸»è¦ç”¨é€”æ˜¯ä¸Žç”¨æˆ·äº’åŠ¨ï¼Œä»¥åŠæ“ä½œ DOMã€‚è¿™å†³å®šäº†å®ƒåªèƒ½æ˜¯å•çº¿ç¨‹,ä¿è¯æ‰§è¡Œä»»åŠ¡çš„æœ‰åºå¹¶é¿å¼€å¤æ‚çš„åŒæ­¥é—®é¢˜ã€‚
 
## æµè§ˆå™¨ä¸­çš„äº‹ä»¶å¾ªçŽ¯
[https://html.spec.whatwg.org/multipage/webappapis.html#event-loops](https://html.spec.whatwg.org/multipage/webappapis.html#event-loops)
![[Pasted image 20250218095926.png]]
æµè§ˆå™¨æ˜¯å¤šçº¿ç¨‹çš„ï¼Œjsæ˜¯å•çº¿ç¨‹çš„ï¼ŒJavaScript æœ‰ä¸€ä¸ªåŸºäºŽ**äº‹ä»¶å¾ªçŽ¯**çš„è¿è¡Œæ—¶æ¨¡åž‹ï¼Œäº‹ä»¶å¾ªçŽ¯è´Ÿè´£æ‰§è¡Œä»£ç ã€æ”¶é›†å’Œå¤„ç†äº‹ä»¶ä»¥åŠæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å­ä»»åŠ¡ã€‚é€šè¿‡è®²ç›‘è§†è°ƒç”¨[[æ ˆ]]`Call Queue`å’Œä»»åŠ¡é˜Ÿåˆ—`Task Queue`ï¼Œåœ¨è°ƒç”¨æ ˆä¸ºç©ºæ—¶ä»Žä»»åŠ¡é˜Ÿåˆ—è¯»å–ä»»åŠ¡è¿›å…¥[[Javascriptè¿è¡ŒåŽŸç†#ðŸª£æ‰§è¡ŒçŽ¯å¢ƒ æ ˆ ECStack - execution context stack(`ESC`)|æ‰§è¡Œæ ˆ]]æ‰§è¡Œã€‚

### è°ƒç”¨[[æ ˆ]] 
[[æ ˆ]] ç»“æž„ï¼ŒåŽè¿›å…ˆå‡ºï¼Œå­˜å‚¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ ä¸­åˆ›å»ºçš„æ‰€æœ‰æ‰§è¡Œä¸Šä¸‹æ–‡`Excution Context`ã€‚åœ¨ä»£ç æ‰§è¡Œçš„æ—¶å€™ï¼Œé€šè¿‡å°†ä¸åŒå‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡åŽ‹å…¥[[Javascriptè¿è¡ŒåŽŸç†#ðŸª£æ‰§è¡ŒçŽ¯å¢ƒ æ ˆ ECStack - execution context stack(`ESC`)|æ‰§è¡Œæ ˆ]]ï¼Œä¸Šä¸‹æ–‡æ‰§è¡Œç»“æŸåŽæŒ‰é¡ºåºå¼¹å‡ºä¸­æ¥ä¿è¯ä»£ç çš„æœ‰åºæ‰§è¡Œã€‚

### ä»»åŠ¡é˜Ÿåˆ—
ä»»åŠ¡é˜Ÿåˆ—`Task Queue`âš ï¸å¹¶ä¸æ˜¯é˜Ÿåˆ—ç»“æž„ï¼Œè€Œæ˜¯[[é›†åˆ]]setï¼Œå­˜å‚¨å¾…å¤„ç†çš„äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å¯èƒ½åŒ…æ‹¬ç”¨æˆ·äº¤äº’ï¼ˆç‚¹å‡»æ»šåŠ¨ï¼‰ï¼Œç½‘ç»œè¯·æ±‚ï¼Œå®šæ—¶å™¨ç­‰ã€‚äº‹ä»¶å¾ªçŽ¯æ¨¡åž‹ä»Žä»»åŠ¡é˜Ÿåˆ—ä¸­æŠ“åŽ»ç¬¬ä¸€ä¸ªå¯æ‰§è¡Œçš„ä»»åŠ¡è€Œä¸æ˜¯é˜Ÿå¤´ã€‚
- åŒç§ä»»åŠ¡ä¼šéµå¾ª**FIFO (First In, First Out)**ã€‚
- ä¸åŒç§ä»»åŠ¡ï¼šå®/å¾®ä»»åŠ¡ï¼ŒUIäº¤äº’äº‹ä»¶ï¼Œå®šæ—¶å™¨ï¼ŒI/Oå›žè°ƒä¼šæœ‰ä¸åŒçš„æ‰§è¡Œä¼˜å…ˆçº§ã€‚
### å®ä»»åŠ¡é˜Ÿåˆ—
**å®¿ä¸»**çŽ¯å¢ƒä¸‹å‘ä»»åŠ¡
- æ•´ä½“scriptï¼ˆç›¸å¯¹çš„ï¼‰
- setTimeout
- setInterval
- setImmediate
- I/O
- UI rendering
### å¾®ä»»åŠ¡é˜Ÿåˆ—
jså¼•æ“Žè‡ªå·±åˆ›å»ºçš„ä»»åŠ¡
- Promiseå›žè°ƒï¼ˆthen, catch, finally...ï¼‰
- MutationObserver
- queueMicrotaskï¼ˆæ˜¾å¼æ’å…¥å¾®ä»»åŠ¡ï¼‰
- âš ï¸process.nextï¼ˆNodeçŽ¯å¢ƒä¸­ï¼‰

### æ‰§è¡Œé¡ºåº
1. ç¨‹åºæ‰§è¡Œï¼ŒæŒ‰é¡ºåºå°†æ‰§è¡Œä¸Šä¸‹åˆåŽ‹å…¥æ‰§è¡Œ[[æ ˆ]] ä¸­
2. æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¼‚æ­¥ä»»åŠ¡ä¼šè®²ä»–ä»¬çš„å›žè°ƒå‡½æ•°åˆ†åˆ«æ”¾å…¥å®ä»»åŠ¡/å¾®ä»»åŠ¡é˜Ÿåˆ—
3. æ‰§è¡Œ[[æ ˆ]] ä¸ºç©ºåŽï¼Œè¯»å–å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œ
	1. å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„å¾®ä»»åŠ¡ä¼šæŽ¨å…¥æœ¬è½®å¾®ä»»åŠ¡é˜Ÿåˆ—
	2. å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„å®ä»»åŠ¡ä¼šåŠ å…¥ä¸‹ä¸€è½®äº‹ä»¶å¾ªçŽ¯
	3. â­ï¸async function
		1. await å…³é”®å­—ä¼šå°†å‡½æ•°å†…çš„å‰©ä½™ä»£ç è§„åˆ’ä¸ºå¾®ä»»åŠ¡
	4. â­ï¸Promise.then.then
		1. é“¾å¼è°ƒç”¨çš„Promiseå›žè°ƒå¿…é¡»ç­‰å¾…å½“å‰å¾®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºï¼ˆæ³¨æ„é¢è¯•é¢˜ä¸­çš„thenæ·±åº¦æ˜¯å¦ç›¸åŒï¼‰
		2. ç¬¬äºŒä¸ªthenéœ€ç­‰å¾…å½“å‰å¾®ä»»åŠ¡æ‰§è¡Œå®Œï¼Œè€Œç¬¬ä¸€ä¸ªthenç›´æŽ¥æŽ¨è¿›å½“å‰å¾®ä»»åŠ¡é˜Ÿåˆ—
4. æµè§ˆå™¨è¿›è¡Œæ¸²æŸ“
5. æ‰§è¡Œ[[æ ˆ]] ä¸ºç©ºåŽï¼Œè¯»å–å®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œ
	1. â­ï¸å¦‚æžœå®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºäº†æ–°çš„å¾®ä»»åŠ¡ï¼Œä¼šåœ¨ä¸‹ä¸ªå®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œ
	2. å¦‚æžœå®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºäº†æ–°çš„å®ä»»åŠ¡ï¼Œä¼šåŠ å…¥ä¸‹ä¸€è½®äº‹ä»¶å¾ªçŽ¯
6. ä¸‹ä¸€è½®å¾ªçŽ¯

#### test
1. å®ä»»åŠ¡æ´¾ç”Ÿ
	```javascript
console.log("Start");

setTimeout(() => {
    console.log("Macrotask A");
    Promise.resolve().then(() => {
        console.log("Microtask 1");
        setTimeout(() => console.log("Macrotask A-1"), 0);
    });
}, 0);

setTimeout(() => {
    console.log("Macrotask B");
}, 0);

console.log("End");
```
2. å¾®ä»»åŠ¡æ´¾ç”Ÿ
	```javascript
console.log("Start");


Promise.resolve().then(() => {
	console.log("Microtask A start");
	Promise.resolve().then(() => {
		console.log("Microtask A-1");
	})
	setTimeout(() => console.log("Macrotask A-1"), 0);
	Promise.resolve().then(() => {
		console.log("Microtask A-2");
	})
	console.log("Microtask A end");
});

Promise.resolve().then(() => {
	console.log("Microtask B");
	Promise.resolve().then(() => {
		console.log("Microtask B-1");
	})
});

console.log("End");

/** 
start
end
Microtask A start
Microtask A end
Microtask B
Microtask A-1
Microtask A-2
Microtask B-1
Macrotask A-1
*/



```
1. Promise é“¾å¼è°ƒç”¨
	```javascript
/// 1
console.log("Start");

Promise.resolve()
Â  .then(() => {
Â  Â  console.log("First then");
Â  Â  Promise.resolve().then(() => {
Â  Â  Â  console.log("Inner then");
Â  Â  });
Â  })

Â  .then(() => {
Â  Â  console.log("Second then");
Â  });

console.log("End");

/// 2
new Promise((resolve, reject) => {
    	console.log("promise1"); // 1
    	resolve();
    })
    	.then(() => {
    		console.log("then11"); // 2
    		new Promise((resolve, reject) => {
    			console.log("promise2"); // 3
    			resolve();
    		})
    			.then(() => {
    				console.log("then21"); // 4
    			})
    			.then(() => {
    				console.log("then23"); // 6
    			});
    	})
    	.then(() => {
    		console.log("then12"); // 5
    	});

/** å¾®ä»»åŠ¡é˜Ÿåˆ—
then11 ,  new Promise , then12
new Promise , then12
then21 , then12 ,then23
*/


    new Promise((resolve, reject) => {
    	console.log("promise");// 1
    	resolve();
    })
    	.then(() => {
    		console.log("thenA");//2
    		new Promise((resolve, reject) => {
    			console.log("promiseA-1");//3
    			resolve();
    		})
    			.then(() => {
    				console.log("thenA-1"); //4
    			})
    			.then(() => {
    				console.log("thenA-1-1");//7
    			});
    	})
    	.then(() => {
    		console.log("thenB");//5
            new Promise((resolve, reject) => {
    			console.log("promiseB-1");//6
    			resolve();
    		})
    			.then(() => {
    				console.log("thenB-1");//8
    			})
    			.then(() => {
    				console.log("thenB-1-1");//9
    			});
    	});
/** å¾®ä»»åŠ¡é˜Ÿåˆ—
thenA , new PromiseA-1 , thenB ,new PromiseB-1
new PromiseA-1 , thenB ,new PromiseB-1
thenA-1 , thenB ,new PromiseB-1 , thenA-1-1
thenA-1-1 , thenB-1, thenB-1-1

*/
```
2. async 
	```javascript
    async function async1() {
    	console.log("async1 start");
    	await async2();
    	console.log("async1 end"); // (â­ï¸Microtask - 1)
    }

    async function async2() {
    	console.log("async2");
    }

    console.log("script start");

    async1();

    new Promise(function (resolve) {
    	console.log("promise1");
    	resolve();
    }).then(function () {
    	console.log("promise2");// (â­ï¸Microtask - 2)
    });
    console.log("script end");

/** execution
script start
async1 start
async2
promise1
script end
async1 end
promise2
*/


async function async1() {
	console.log("async1 start"); 
	await async2();
	console.log("async1 end"); // (â­ï¸Microtask - 1)
}

async function async2() {
	console.log("async2"); 
}

console.log("script start"); 

setTimeout(function () {
	console.log("settimeout");
});

async1();

new Promise(function (resolve) {
	console.log("promise1"); 
	resolve();
}).then(function () {
	console.log("promise2"); // (â­ï¸Microtask - 2)
});

console.log("script end"); 


/** 
script start
async1 start
async2
promise1
script end
async1 end
promise2
settimeout
*/
```


## Nodeçš„äº‹ä»¶å¾ªçŽ¯
### libuv
>nodeçš„äº‹ä»¶å¾ªçŽ¯æ¨¡åž‹ç”±[libuv](https://libuv.org/)å®žçŽ°ã€‚
>libuv is a multi-platform support library with a focus on asynchronous I/O.
![[Pasted image 20250218125318.png]]

### äº‹ä»¶å¾ªçŽ¯
[https://nodejs.org/en/learn/asynchronous-work/event-loop-timers-and-nexttick#event-loop-explained](https://nodejs.org/en/learn/asynchronous-work/event-loop-timers-and-nexttick#event-loop-explained)
![[Pasted image 20250218125604.png]]
å„é˜¶æ®µè¯´æ˜Ž
- **timers**: æ‰§è¡Œå®šæ—¶å™¨å›žè°ƒ
	- this phase executes callbacks scheduled byÂ `setTimeout()`Â andÂ `setInterval()`.
- **pending callbacks**: æ‰§è¡Œä¸Šä¸€è½®å¾ªçŽ¯ä¸­å»¶è¿Ÿæ‰§è¡Œçš„I/O
	- executes I/O callbacks deferred to the next loop iteration.
	- æ¯”å¦‚[[TCP]]è¿žæŽ¥çš„äº‹ä»¶
- **idle, prepare**: ç³»ç»Ÿå†…éƒ¨è°ƒç”¨
	- only used internally.
- **poll**: è½®è¯¢ï¼Œæ£€ç´¢æ–°çš„I/Oäº‹ä»¶ï¼Œæ‰§è¡ŒI/Oå›žè°ƒï¼Œé™¤äº†å®šæ—¶å™¨,setImmediateå›žè°ƒå’Œå…³é—­å›žè°ƒ
	- retrieve new I/O events; execute I/O related callbacks (almost all with the exception of close callbacks, the ones scheduled by timers, andÂ `setImmediate()`); node will block here when appropriate.
- **check**:Â setImmediateå›žè°ƒæ‰§è¡Œ
	- `setImmediate()`Â callbacks are invoked here.
- **close callbacks**: å…³é—­å›žè°ƒï¼Œå„ç§on('close')
	- some close callbacks, e.g.Â `socket.on('close', ...)`.

### ä»»åŠ¡é˜Ÿåˆ—
nodeçš„äº‹ä»¶å¾ªçŽ¯ï¼Œå¯¹äºŽå¾®ä»»åŠ¡ç»†åˆ†ä¸ºä¸¤ç§ã€‚
- nextTickQueue
	- å•ç‹¬ç»™process.nextä½¿ç”¨
	- ä¸­æ–­nodeæ‰§è¡Œé˜¶æ®µçš„ç»§ç»­ï¼Œé˜»æ­¢è¿›å…¥`poll`é˜¶æ®µ
		- all callbacks passed toÂ `process.nextTick()`Â will be resolved before the event loop continues.
- other queue
	- å…¶ä½™å¾®ä»»åŠ¡
#### `rpocess.nexttick`
ä¸­æ–­nodeæ‰§è¡Œé˜¶æ®µçš„ç»§ç»­ï¼Œåœ¨æ‰§è¡Œå®Œå®ä»»åŠ¡é˜Ÿåˆ—åŽé˜»æ­¢è¿›å…¥`poll`é˜¶æ®µã€‚
```javascript
const server = net.createServer(() => {}).listen(8080);
// listen()å‡½æ•°å·²ç»è¢«æ‰§è¡Œï¼Œä¸‹é¢çš„äº‹ä»¶ç»‘å®šåº”è¯¥æ˜¯å¤±æ•ˆçš„
server.on('listening', () => {});
// ä½†æ˜¯listeningäº‹ä»¶æ˜¯ç”¨nextTick()åŒ…è£¹ï¼Œä»Žè€Œåœ¨æ•´æ®µä»£ç ä»£ç æ‰§è¡Œ åŽè¿è¡Œ
```
âš ï¸tickæŒ‡çš„æ˜¯ä¸€æ¬¡äº‹ä»¶å‘¨æœŸï¼Œè€ŒnextTickçš„æ‰§è¡Œæ—¶æœºå¹¶æ²¡æœ‰åœ¨ä¸‹ä¸€ä¸ª`tick`ä¹‹å‰ï¼Œå…¶åŽè¿˜æœ‰ä¸€`check`é˜¶æ®µã€‚è¿™çŽ©æ„åŽ†å²åŒ…è¢±å·²ç»æ”¹ä¸äº†äº†ã€‚

#### `setImmediate`
åœ¨`check`é˜¶æ®µï¼ˆ`poll`å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå®ŒåŽï¼‰æ‰§è¡Œã€‚
âš ï¸çœŸæ­£çš„next tickðŸ˜‚

#### TEST
```javascript
Promise.resolve().then(() => console.log('Promise.then'));

process.nextTick(() => {

	process.nextTick(() => {
	
		console.log('nextTick1-1');
	
	});

console.log('nextTick1');

});

process.nextTick(() => console.log('nextTick2'));

console.log('end');


// end

// nextTick(nextTick1-1) nextTick1 nextTick2 Promisethen

// nextTick1 nextTick2 nextTick1-1 Promisethen
```