
## é¡µé¢è¿›ç¨‹
æµè§ˆå™¨æ¯ä¸€ä¸ªæ ‡ç­¾é¡µä¸€ä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹ä¸­é™¤äº†æ‰§è¡Œjsçš„çº¿ç¨‹è¿˜æœ‰è´Ÿè´£æ¸²æŸ“ï¼Œç½‘ç»œè¯·æ±‚ç­‰çº¿ç¨‹ã€‚

## JS çš„å•çº¿ç¨‹
JavaScript çš„å•çº¿ç¨‹ï¼Œä¸å®ƒçš„ç”¨é€”æœ‰å…³ã€‚ä½œä¸ºæµè§ˆå™¨è„šæœ¬è¯­è¨€ï¼ŒJavaScript çš„ä¸»è¦ç”¨é€”æ˜¯ä¸ç”¨æˆ·äº’åŠ¨ï¼Œä»¥åŠæ“ä½œ DOMã€‚è¿™å†³å®šäº†å®ƒåªèƒ½æ˜¯å•çº¿ç¨‹,ä¿è¯æ‰§è¡Œä»»åŠ¡çš„æœ‰åºå¹¶é¿å¼€å¤æ‚çš„åŒæ­¥é—®é¢˜ã€‚
 
## æµè§ˆå™¨ä¸­çš„äº‹ä»¶å¾ªç¯
[https://html.spec.whatwg.org/multipage/webappapis.html#event-loops](https://html.spec.whatwg.org/multipage/webappapis.html#event-loops)
![](../../assets/Pasted%20image%2020250218095926.png)
æµè§ˆå™¨æ˜¯å¤šçº¿ç¨‹çš„ï¼Œjsæ˜¯å•çº¿ç¨‹çš„ï¼ŒJavaScript æœ‰ä¸€ä¸ªåŸºäº**äº‹ä»¶å¾ªç¯**çš„è¿è¡Œæ—¶æ¨¡å‹ï¼Œäº‹ä»¶å¾ªç¯è´Ÿè´£æ‰§è¡Œä»£ç ã€æ”¶é›†å’Œå¤„ç†äº‹ä»¶ä»¥åŠæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å­ä»»åŠ¡ã€‚é€šè¿‡è®²ç›‘è§†è°ƒç”¨[[æ ˆ]]`Call Queue`å’Œä»»åŠ¡é˜Ÿåˆ—`Task Queue`ï¼Œåœ¨è°ƒç”¨æ ˆä¸ºç©ºæ—¶ä»ä»»åŠ¡é˜Ÿåˆ—è¯»å–ä»»åŠ¡è¿›å…¥[[Javascriptè¿è¡ŒåŸç†#ğŸª£æ‰§è¡Œç¯å¢ƒ æ ˆ ECStack - execution context stack(`ESC`)|æ‰§è¡Œæ ˆ]]æ‰§è¡Œã€‚

### è°ƒç”¨[[æ ˆ]] 
[[æ ˆ]] ç»“æ„ï¼Œåè¿›å…ˆå‡ºï¼Œå­˜å‚¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ ä¸­åˆ›å»ºçš„æ‰€æœ‰æ‰§è¡Œä¸Šä¸‹æ–‡`Excution Context`ã€‚åœ¨ä»£ç æ‰§è¡Œçš„æ—¶å€™ï¼Œé€šè¿‡å°†ä¸åŒå‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡å‹å…¥[[Javascriptè¿è¡ŒåŸç†#ğŸª£æ‰§è¡Œç¯å¢ƒ æ ˆ ECStack - execution context stack(`ESC`)|æ‰§è¡Œæ ˆ]]ï¼Œä¸Šä¸‹æ–‡æ‰§è¡Œç»“æŸåæŒ‰é¡ºåºå¼¹å‡ºä¸­æ¥ä¿è¯ä»£ç çš„æœ‰åºæ‰§è¡Œã€‚

### ä»»åŠ¡é˜Ÿåˆ—
ä»»åŠ¡é˜Ÿåˆ—`Task Queue`âš ï¸å¹¶ä¸æ˜¯é˜Ÿåˆ—ç»“æ„ï¼Œè€Œæ˜¯[[é›†åˆ]]setï¼Œå­˜å‚¨å¾…å¤„ç†çš„äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å¯èƒ½åŒ…æ‹¬ç”¨æˆ·äº¤äº’ï¼ˆç‚¹å‡»æ»šåŠ¨ï¼‰ï¼Œç½‘ç»œè¯·æ±‚ï¼Œå®šæ—¶å™¨ç­‰ã€‚äº‹ä»¶å¾ªç¯æ¨¡å‹ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­æŠ“å»ç¬¬ä¸€ä¸ªå¯æ‰§è¡Œçš„ä»»åŠ¡è€Œä¸æ˜¯é˜Ÿå¤´ã€‚
- åŒç§ä»»åŠ¡ä¼šéµå¾ª**FIFO (First In, First Out)**ã€‚
- ä¸åŒç§ä»»åŠ¡ï¼šå®/å¾®ä»»åŠ¡ï¼ŒUIäº¤äº’äº‹ä»¶ï¼Œå®šæ—¶å™¨ï¼ŒI/Oå›è°ƒä¼šæœ‰ä¸åŒçš„æ‰§è¡Œä¼˜å…ˆçº§ã€‚
### å®ä»»åŠ¡é˜Ÿåˆ—
**å®¿ä¸»**ç¯å¢ƒä¸‹å‘ä»»åŠ¡
- æ•´ä½“scriptï¼ˆç›¸å¯¹çš„ï¼‰
- setTimeout
- setInterval
- setImmediate
- I/O
- UI rendering
### å¾®ä»»åŠ¡é˜Ÿåˆ—
jså¼•æ“è‡ªå·±åˆ›å»ºçš„ä»»åŠ¡
- Promiseå›è°ƒï¼ˆthen, catch, finally...ï¼‰
- MutationObserver
- queueMicrotaskï¼ˆæ˜¾å¼æ’å…¥å¾®ä»»åŠ¡ï¼‰
- âš ï¸process.nextTickï¼ˆNodeç¯å¢ƒä¸­ï¼‰

### æ‰§è¡Œé¡ºåº
1. ç¨‹åºæ‰§è¡Œï¼ŒæŒ‰é¡ºåºå°†æ‰§è¡Œä¸Šä¸‹åˆå‹å…¥æ‰§è¡Œ[[æ ˆ]] ä¸­
2. æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¼‚æ­¥ä»»åŠ¡ä¼šå°†ä»–ä»¬çš„å›è°ƒå‡½æ•°åˆ†åˆ«æ”¾å…¥å®ä»»åŠ¡/å¾®ä»»åŠ¡é˜Ÿåˆ—
3. æ‰§è¡Œ[[æ ˆ]] ä¸ºç©ºåï¼Œè¯»å–å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œ
	1. å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„å¾®ä»»åŠ¡ä¼šæ¨å…¥æœ¬è½®å¾®ä»»åŠ¡é˜Ÿåˆ—
	2. å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„å®ä»»åŠ¡ä¼šåŠ å…¥ä¸‹ä¸€è½®äº‹ä»¶å¾ªç¯
	3. â­ï¸async function
		1. await å…³é”®å­—ä¼šå°†å‡½æ•°å†…çš„å‰©ä½™ä»£ç è§„åˆ’ä¸ºå¾®ä»»åŠ¡
	4. â­ï¸Promise.then.then
		1. é“¾å¼è°ƒç”¨çš„Promiseå›è°ƒå¿…é¡»ç­‰å¾…å½“å‰å¾®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºï¼ˆæ³¨æ„é¢è¯•é¢˜ä¸­çš„thenæ·±åº¦æ˜¯å¦ç›¸åŒï¼‰
		2. ç¬¬äºŒä¸ªthenéœ€ç­‰å¾…å½“å‰å¾®ä»»åŠ¡æ‰§è¡Œå®Œï¼Œè€Œç¬¬ä¸€ä¸ªthenç›´æ¥æ¨è¿›å½“å‰å¾®ä»»åŠ¡é˜Ÿåˆ—
4. æµè§ˆå™¨è¿›è¡Œæ¸²æŸ“
5. æ‰§è¡Œ[[æ ˆ]] ä¸ºç©ºåï¼Œè¯»å–å®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œ
	1. â­ï¸å¦‚æœå®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºäº†æ–°çš„å¾®ä»»åŠ¡ï¼Œä¼šåœ¨ğŸ‘€*ä¸‹ä¸ªå®ä»»åŠ¡ä¹‹å‰*æ‰§è¡Œ
	2. å¦‚æœå®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºäº†æ–°çš„å®ä»»åŠ¡ï¼Œä¼šåŠ å…¥ä¸‹ä¸€è½®äº‹ä»¶å¾ªç¯
6. ä¸‹ä¸€è½®å¾ªç¯

#### test
```javascript
console.log("Start"); //1 

setTimeout(() => {
    console.log("Macrotask A");//3
    Promise.resolve().then(() => {
        console.log("Microtask 1"); //4
        setTimeout(() => console.log("Macrotask A-1"), 0); //6
    });
}, 0);

setTimeout(() => {
    console.log("Macrotask B");//5
}, 0);

console.log("End");//2
```
2. 
```javascript
console.log("Start"); // 1


Promise.resolve().then(() => {
	console.log("Microtask A start"); // 3
	Promise.resolve().then(() => {
		console.log("Microtask A-1"); // 6
	})
	setTimeout(() => console.log("Macrotask A-1"), 0); // 9
	Promise.resolve().then(() => {
		console.log("Microtask A-2"); // 7
	})
	console.log("Microtask A end"); // 4
});

Promise.resolve().then(() => {
	console.log("Microtask B"); // 5
	Promise.resolve().then(() => {
		console.log("Microtask B-1"); // 8
	})
});

console.log("End"); //2
```

```javascript

Promise.resolve()
    	.then(() => {
    		console.log("then1");
    		Promise.resolve()
    			.then(() => {
    				console.log("then11");
    			})
    			.then(() => {
    				console.log("then12");
    			});
    	})
    	.then(() => {
// é“¾å¼è°ƒç”¨çš„thenéœ€è¦ç­‰ä¸Šä¸€ä¸ªthenä¸­åŒæ­¥ä»£ç æ‰§è¡Œå®Œ
    		console.log("then2"); 
			Promise.resolve()
    			.then(() => {
    				console.log("then21");
    			})
    			.then(() => {
    				console.log("then22"); 
    			});
    	})

/** 
å¾®ä»»åŠ¡é˜Ÿåˆ— -> è¾“å‡º
[{then1}]
[{then11},{then2}] -> then1
[{then2},{then12}] -> then11
[{then12},{then21}] -> then2
[{then22}] -> then12,then21
[] -> then22


then1
VM381:6 then11
VM381:13 then2
VM381:9 then12
VM381:16 then21
VM381:19 then22
*/
```

```javascript
async function async1() {
	console.log("async1 start"); 
	await async2(); // async2ä¼šåŒæ­¥æ‰§è¡Œï¼Œä½†awaitä¸‹é¢çš„ä»£ç ä¼šåŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ä»¥ç­‰å¾…awaitå³ä¾§ä»£ç å¾—å‡ºstatus
	console.log("async1 end"); // (microtask)
}

async function async2() {
	console.log("async2"); 
}

console.log("script start"); 

setTimeout(function () {
	console.log("settimeout");
});

async1();

new Promise(function (resolve) {
	console.log("promise1"); 
	resolve();
}).then(function () {
	console.log("promise2"); // (microtask)
});

console.log("script end"); 


/** 
script start
async1 start
async2
promise1
script end
async1 end
promise2
settimeout
*/
```

```javascript
setTimeout(function(){
	console.log('setTimeout1') // 6
	Promise.resolve().then(()=>{
	Promise.resolve().then(()=>{
		console.log('then4')//8
	})
	console.log('then2') // 7
	})
})

new Promise(function(resolve){
	console.log('promise1') // 1
	resolve()
}).then(function(){
	console.log('then1') // 3
})

setTimeout(function(){
	console.log('steTimeout2')//9
})

console.log(2) // 2

queueMicrotask(()=>{
	console.log('queueMicrotask1')// 4
})

Promise.resolve().then(()=>{
	console.log('then3') // 5
})

```

```javascript
// return normal æ­£å¸¸æ‰§è¡Œé¡ºåº
Promise.resolve().then(()=>{
	console.log(0) 
	return 4
}).then((res)=>{
	console.log(res) 
})

Promise.resolve().then(()=>{
	console.log(1) 
}).then(()=>{
	console.log(2)
}).then(()=>{
	console.log(3)
}).then(()=>{
	console.log(5)
}).then(()=>{
	console.log(6)
})
// 0 1 4 2 3 5 6

//â­ï¸ return thenable æ‰§è¡Œé¡ºåºå¾€å+1
Promise.resolve().then(()=>{
	console.log(0) 
	return {
		then(resolve){
			resolve(4)
		}
	}
}).then((res)=>{
	console.log(res) 
})

Promise.resolve().then(()=>{
	console.log(1) 
}).then(()=>{
	console.log(2)
}).then(()=>{
	console.log(3)
}).then(()=>{
	console.log(5)
}).then(()=>{
	console.log(6)
})
// 0 1 2 4 3 5 6


//â­ï¸ return Promise æ‰§è¡Œé¡ºåºå¾€å+2
Promise.resolve().then(()=>{
	console.log(0) 
	return Promise.resolve(4)
}).then((res)=>{
	console.log(res) 
})

Promise.resolve().then(()=>{
	console.log(1) 
}).then(()=>{
	console.log(2)
}).then(()=>{
	console.log(3)
}).then(()=>{
	console.log(5)
}).then(()=>{
	console.log(6)
})
// 0 1 2 3 4 5 6
```

```js
async function test1(){
    Promise.resolve().then(()=>{ // Promise å›è°ƒ 1 (P1)
        console.log('micro task1')
    })

    await console.log('sync after await') // await è¡¨è¾¾å¼ 1 (A1)

    Promise.resolve().then(()=>{ // Promise å›è°ƒ 2 (P2)
        console.log('micro task2')
    })
}

// å‡è®¾æˆ‘ä»¬ç«‹å³è°ƒç”¨ test1()
test1();
// P1.then åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
// æ‰“å° sync after await
// P2 åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
// æ‰§è¡ŒP1.then
// micro task1
// P2.then åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
// micro task2


async function test2(){
    await Promise.resolve().then(()=>{ // await Promise 1 (AP1)
        console.log('micro task1')
    })

    await console.log('sync after await') // await è¡¨è¾¾å¼ 1 (A1)

    await Promise.resolve().then(()=>{ // await Promise 2 (AP2)
        console.log('micro task2')
    })
}

// å‡è®¾æˆ‘ä»¬ç«‹å³è°ƒç”¨ test2()
test2();
// micro task1
// sync after await
// micro task2
```